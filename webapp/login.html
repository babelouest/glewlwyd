<!--
 * 
 * Glewlwyd SSO Server
 *
 * Login/Logout page
 *
 * Copyright 2017-2018 Nicolas Mora <mail@babelouest.org>
 * 
 * The front-end application is under MIT Licence (MIT)
 * 
 * The MIT License (MIT)
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 -->
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Glewlwyd login page</title>
		<link href="favicon.ico" rel="icon" type="image/x-icon" />
		<meta name="description" content="Glewlwyd OAuth2 Authorization Server">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="css/bootstrap.min.css">
		<style>
		body {
			padding-top: 40px;
			padding-bottom: 40px;
			background-color: #eee;
		}

		.form-signin {
			max-width: 330px;
			padding: 15px;
			margin: 0 auto;
		}
		.form-signin .form-signin-heading,
		.form-signin .checkbox {
			margin-bottom: 10px;
		}
		.form-signin .checkbox {
			font-weight: normal;
		}
		.form-signin .form-control {
			position: relative;
			height: auto;
			-webkit-box-sizing: border-box;
			 -moz-box-sizing: border-box;
					box-sizing: border-box;
			padding: 10px;
			font-size: 16px;
		}
		.form-signin .form-control:focus {
			z-index: 2;
		}
		.form-signin input[type="email"] {
			margin-bottom: -1px;
			border-bottom-right-radius: 0;
			border-bottom-left-radius: 0;
		}
		.form-signin input[type="password"] {
			margin-bottom: 10px;
			border-top-left-radius: 0;
			border-top-right-radius: 0;
		}
		</style>
	</head>
	<body>
		<div class="container" id="passwordDiv">
			<form class="form-signin" action="#" id="passwordForm" style="display: none;">
				<h2 class="form-signin-heading">Please sign in</h2>
				<label class="sr-only" for="inputLogin">Login</label>
				<input type="text" class="form-control" name="username" id="username" autofocus="" required="" placeholder="user name">
				<label class="sr-only" for="inputPassword">Password</label>
				<input type="password" class="form-control" name="password" id="password" required="" placeholder="password">
				<button type="submit" name="loginbut" id="loginbut" class="btn btn-lg btn-primary btn-block">Sign in</button>
			</form>
		</div>
		<div class="container" id="userDiv" style="display: none;">
			<div class="form-signin">
				<h2>You are connected as <span id="currentUser"></span></h2>
				<label>What do you wish for?</label>
                                <div class="btn-group-vertical">
					<button type="button" name="currentUsernameValid" id="currentUsernameValid" class="btn btn-lg btn-primary btn-block">Continue</button>
					<button type="button" name="profile" id="profile" class="btn btn-lg btn-primary btn-block">Update profile</button>
					<button type="button" name="switchUser" id="switchUser" style="display: none;" class="btn btn-lg btn-primary btn-block dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Switch user</button>
        	                        <div class="dropdown-menu" aria-labelledby="switchUser" id="switchUserList"></div>
					<button type="button" name="logoutbut" id="logoutbut" class="btn btn-lg btn-primary btn-block">Log out</button>
                                </div>
			</div>
		</div>
		<script src="js/jquery.min.js"></script>
		<script src="js/popper.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
	</body>
	
<script>
$(function () {
  var currentUser = false;
  var userList = [];

  $("#passwordForm").submit(function (e) {
    e.preventDefault();
    checkPassword();
  });

  var checkPassword = function() {
    var scheme = {
      scheme: "password",
      username: $("#username").val(),
      password: $("#password").val()
    };

    $.ajax({
      type: "POST",
      url: "api/auth/user/",
      data: JSON.stringify(scheme),
      contentType: "application/json; charset=utf-8",
      success: function () {
        console.log("yeah");
      }
    });
  };

  var switchUser = function(user) {
    currentUser = user;
    fillUserList(userList, user);
  };

  var fillUserList = function(userList, currentUser) {
    $("#currentUser").html(currentUser.name);
    if (userList.length > 1) {
      $("#switchUser").show();
      $("#switchUserList").empty();
      $.each(userList, function (i, user) {
        if (user.username === currentUser.username) {
          $("#switchUserList").append('<a class="dropdown-item active" href="#" id="switchUser-' + user.username + '">' + user.name + '</a>');
        } else {
          $("#switchUserList").append('<a class="dropdown-item" href="#" id="switchUser-' + user.username + '">' + user.name + '</a>');
        }
        $("#switchUser-" + user.username).click(function () {
          switchUser(user);
        });
      });
    } else {
      $("#switchUser").hide();
    }
  };

  var init = function() {
    $.ajax({
      url: "api/auth/user/",
      success: function (res) {
        $("#passwordDiv").hide()
        $("#userDiv").show();
        for (var i in res) {
          var lastLogin = new Date(res[i].last_login);
          if (!currentUser) {
            currentUser = res[i];
          } else {
            var curLastLogin = new Date(currentUser.last_login);
            if (lastLogin.getTime() > curLastLogin.getTime()) {
              currentUser = res[i];
            }
          }
          userList.push(res[i]);
        }
        fillUserList(userList, currentUser);
      },
      fail: function () {
        $("#passwordDiv").show()
        $("#userDiv").hide();
      }
    });
  };

  init();
});
</script>
</html>
