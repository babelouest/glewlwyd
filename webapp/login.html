<!--
 * 
 * Glewlwyd SSO Server
 *
 * Login/Logout page
 *
 * Copyright 2019 Nicolas Mora <mail@babelouest.org>
 * 
 * The front-end application is under MIT Licence (MIT)
 * 
 * The MIT License (MIT)
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 -->
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Glewlwyd login page</title>
		<link href="favicon.ico" rel="icon" type="image/x-icon" />
		<meta name="description" content="Glewlwyd SSO Authorization Server">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="css/bootstrap.min.css">
	</head>
	<body>
		<div class="container">
			<div class="card center" id="userCard" tabindex="-1" role="dialog" style="display: none;">
				<div class="card-header">
					<h2>Glewlwyd SSO service</h2>
				</div>
				<div class="card-body">
					<h3>You are connected as <span id="currentUser"></span></h3>
					<label>What do you wish for?</label>
				</div>
				<div class="card-footer">
					<div class="btn-group" role="group">
						<button type="button" name="continueBut" id="continueBut" class="btn btn-primary">Continue</button>
						<button type="button" name="grantBut" id="grantBut" class="btn btn-primary">Grant or revoke access</button>
						<button type="button" name="profileBut" id="profileBut" class="btn btn-primary">Update profile</button>
						<div class="btn-group" role="group">
							<button type="button" name="switchUser" id="switchUser" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Change user</button>
							<div class="dropdown-menu" aria-labelledby="switchUser" id="switchUserList"></div>
						</div>
						<div class="btn-group" role="group">
							<button type="button" name="selectScheme" id="selectScheme" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Select Scheme</button>
							<div class="dropdown-menu" aria-labelledby="selectScheme" id="selectSchemeList"></div>
						</div>
						<button type="button" name="logoutbut" id="logoutbut" class="btn btn-primary">Log out</button>
					</div>
				</div>
			</div>
			<div class="card center" id="scopesCard" tabindex="-1" role="dialog" style="display: none;">
				<div class="card-header">
					<h2>Scopes summary</h2>
				</div>
				<div class="card-body">
					<div id="scopesSummary"></div>
				</div>
			</div>
		</div>
		<form action="#" id="passwordForm">
			<div class="modal center fade" id="passwordModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							Please enter your username and password
						</div>
						<div class="modal-body">
							<label class="sr-only" for="username">Login</label>
							<input type="text" class="form-control" name="username" id="username" autofocus="" required="" placeholder="username">
							<label class="sr-only" for="password">Password</label>
							<input type="password" class="form-control" name="password" id="password" required="" placeholder="password">
						</div>
						<div class="modal-footer">
							<button type="submit" name="loginbut" id="loginbut" class="btn btn-lg btn-primary btn-block">Sign in</button>
						</div>
					</div>
				</div>
			</div>
		</form>
		<form action="#" id="mockForm">
			<div class="modal center fade" id="mockModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							Please enter the exptected mock value for <span id="mockSchemeName"></span>
						</div>
						<div class="modal-body">
							<input type="text" class="form-control" name="mockValue" id="mockValue" autofocus="" required="" placeholder="value">
							<input type="hidden" name="mockName" id="mockName" value="">
						</div>
						<div class="modal-footer">
							<button type="submit" name="mockSubmit" id="mockSubmit" class="btn btn-lg btn-primary btn-block">Validate</button>
						</div>
					</div>
				</div>
			</div>
		</form>
		<script src="js/jquery.min.js"></script>
		<script src="js/popper.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
	</body>
<script>
$(function () {
	var currentUser = false;
	var userList = [];

	$("#passwordForm").submit(function (e) {
		e.preventDefault();
		checkPassword();
	});

	$("#mockForm").submit(function (e) {
		e.preventDefault();
		checkMock();
	});

	$("#logoutbut").click(function () {
		$.ajax({
			type: "DELETE",
			url: "api/auth/",
			success: function () {
				init();
			}
		});
	});

	$("#grantBut").click(function () {
		var scope = [];
		$(".check-scope").each(function () {
			if ($(this).prop("checked")) {
				scope.push(encodeURI($(this).attr("data-scope")));
			}
		});
		if (getParameterByName("client_id")) {
			$.ajax({
				type: "PUT",
				data: JSON.stringify({scope: (scope.join(" ")||"")}),
				contentType: "application/json; charset=utf-8",
				url: "api/auth/grant/" + encodeURI(getParameterByName("client_id")) + "/",
				success: function () {
					init();
				}
			});
		}
	});

	var checkPassword = function() {
		var scheme = {
//			scheme: "password",
			username: $("#username").val(),
			password: $("#password").val()
		};

		$.ajax({
			type: "POST",
			url: "api/auth/",
			data: JSON.stringify(scheme),
			contentType: "application/json; charset=utf-8",
			success: function () {
				init();
			}
		});
	};

	var checkMock = function() {
		var scheme = {
			scheme_type: "mock",
			scheme_name: $("#mockName").val(),
			username: currentUser.username,
			value: {
				code: $("#mockValue").val()
			}
		};

		$.ajax({
			type: "POST",
			url: "api/auth/",
			data: JSON.stringify(scheme),
			contentType: "application/json; charset=utf-8",
			success: function () {
				$("#mockModal").modal('hide');
				init();
			}
		});
	};

	var switchUser = function(user) {
		var scheme = {
			username: user.username,
		};

		$.ajax({
			type: "POST",
			url: "api/auth/",
			data: JSON.stringify(scheme),
			contentType: "application/json; charset=utf-8",
			success: function () {
				init();
			}
		});
	};

	var fillUserList = function(userList, currentUser) {
		currentUser?$("#currentUser").html(currentUser.name):$("#currentUser").html("Not connected");
		$("#switchUserList").empty();
		$("#switchUserList").append('<a class="dropdown-item" href="#" id="switchUserNew">New user</a>');
		$("#switchUserNew").click(function () {
			$("#passwordModal").modal('show');
			$("#userCard").hide();
			$("#scopesCard").hide();
		});
		$.each(userList, function (i, user) {
			if (user.username === currentUser.username) {
				$("#switchUserList").append('<a class="dropdown-item active" href="#" id="switchUser-' + user.username + '">' + user.name + '</a>');
			} else {
				$("#switchUserList").append('<a class="dropdown-item" href="#" id="switchUser-' + user.username + '">' + user.name + '</a>');
			}
			$("#switchUser-" + user.username).click(function () {
				switchUser(user);
			});
		});
	};
	
	var getParameterByName = function (name, url) {
		if (!url) url = window.location.href;
		name = name.replace(/[\[\]]/g, '\\$&');
		var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
				results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, ' '));
	};
	
	var authenticateScheme = function (elt) {
		if (elt.attr('data-type') === "mock") {
			$("#mockSchemeName").text(elt.attr('data-display-name'));
			$("#mockName").val(elt.attr('data-name'));
			$("#mockModal").modal('show');
		}
	};
	
	var fillScopeList = function (scopeList) {
		return $.ajax({
			url: "api/auth/schemes/?scope=" + scopeList,
			success: function (result) {
				$("#selectSchemeList").empty();
				var schemeList = {};
				$("#scopesSummary").empty();
				for (var scope in result) {
					var newScope = '<div class="row"><div class="col-md-3"><h3>Scope</h3></div><div class="col-md-7">' + scope + (result[scope].available?'<span id="scope-' + scope + '"></span>':' (Unavailable)') + '</div><div class="col-md-2"><input type="checkbox" data-scope="' + scope + '" class="form-control check-scope" id="checkScope-' + scope + '"/></div></div>';
					newScope += '<div class="row"><div class="col-md-1"></div><div class="col-md-2"><h5>Password required</h5></div>' + result[scope].password_required + '</div></div>';
					for (var grp in result[scope].schemes) {
						newScope += '<div class="row"><div class="col-md-1"></div><div class="col-md-2"><h5>Group</h5></div><div class="col-md-9">' + grp + '</div></div>';
						for (var sch in result[scope].schemes[grp]) {
							newScope += '<div class="row"><div class="col-md-1"></div><div class="col-md-2"><h6>Scheme</h6></div><div class="col-md-9">' + result[scope].schemes[grp][sch].scheme_name + ' ' + (result[scope].schemes[grp][sch].scheme_authenticated?'(Authenticated)':'(Not authenticated)') + '</div></div>';
							if (!schemeList[result[scope].schemes[grp][sch].scheme_type]) {
								schemeList[result[scope].schemes[grp][sch].scheme_type] = [];
							}
							if (schemeList[result[scope].schemes[grp][sch].scheme_type].indexOf(result[scope].schemes[grp][sch].scheme_name) == -1) {
								schemeList[result[scope].schemes[grp][sch].scheme_type].push(result[scope].schemes[grp][sch].scheme_name);
								$("#selectSchemeList").append('<a class="dropdown-item" href="#" data-type="' + result[scope].schemes[grp][sch].scheme_type + '" data-name="' + result[scope].schemes[grp][sch].scheme_name + '" data-display-name="' + result[scope].schemes[grp][sch].scheme_display_name + '" id="selectScheme-' + result[scope].schemes[grp][sch].scheme_name + '">' + result[scope].schemes[grp][sch].scheme_display_name + '</a>');
								$("#selectScheme-" + result[scope].schemes[grp][sch].scheme_name).click(function () {
									authenticateScheme($(this));
								});
							}
						}
					}
					newScope += '</div><div class="row"><div class="col-md-12"><hr/></div></div>';
					$("#scopesSummary").append(newScope);
				}
			}
		});
	};
	
	var getScopeGrant = function (client_id, scope_list) {
	$.ajax({
		url: "api/auth/grant/" + encodeURI(client_id) + "/" + encodeURI(scope_list),
		success: function (res) {
						for (var i in res.scope) {
							$("#scope-"+res.scope[i].name).html((res.scope[i].granted?" (granted)":" (not granted)"));
																if (res.scope[i].granted) {
																	$("#checkScope-" + res.scope[i].name).prop("checked", true);
																}
						}
		},
		error: function (err) {
		}
	});
	};

	var init = function() {
		$("#passwordModal").modal('hide');
		$("#userCard").show();
		$("#scopesCard").show();
		
		if (getParameterByName("scope")) {
			fillScopeList(getParameterByName("scope")).done(function () {
				getScopeGrant(getParameterByName("client_id"), getParameterByName("scope"));
			});
		}
		
		$.ajax({
			url: "api/auth/",
			success: function (res) {
				userList = [];
				for (var i in res) {
					var lastLogin = new Date(res[i].last_login);
					if (!currentUser) {
						currentUser = res[i];
					} else {
						var curLastLogin = new Date(currentUser.last_login);
						if (lastLogin.getTime() > curLastLogin.getTime()) {
							currentUser = res[i];
						}
					}
					userList.push(res[i]);
				}
				fillUserList(userList, currentUser);
			},
			error: function () {
				fillUserList([]);
			}
		});
		if (getParameterByName("callback_url")) {
			$("#continueBut").attr("disabled", false);
			$("#continueBut").click(function () {
				window.location.href = getParameterByName("callback_url") + "&g_continue";
			});
		} else {
			$("#continueBut").attr("disabled", true);
		}
	};

	init();
});
</script>
</html>
