<!--
 * 
 * Glewlwyd SSO Authorization Server
 *
 * Test oidc behaviour
 *
 * Copyright 2019 Nicolas Mora <mail@babelouest.org>
 * 
 * The front-end application is under MIT Licence (MIT)
 * 
 * The MIT License (MIT)
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 -->
<!doctype html>
<html lang="en">
	<head>
		
		<meta charset="utf-8">
		<title>Glewlwyd test page</title>
		<meta name="description" content="Glewlwyd OAuth2 Authorization Server">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<script src="js/jquery.min.js"></script>
		<link rel="stylesheet" href="css/bootstrap.min.css" crossorigin="anonymous">
		<script src="js/bootstrap.min.js" crossorigin="anonymous"></script>
		<style>
		body {
		  padding-top: 40px;
		  padding-bottom: 40px;
		  background-color: #eee;
		}

		.form-signin {
		  max-width: 330px;
		  padding: 15px;
		  margin: 0 auto;
		}
		.form-signin .form-signin-heading,
		.form-signin .checkbox {
		  margin-bottom: 10px;
		}
		.form-signin .checkbox {
		  font-weight: normal;
		}
		.form-signin .form-control {
		  position: relative;
		  height: auto;
		  -webkit-box-sizing: border-box;
			 -moz-box-sizing: border-box;
				  box-sizing: border-box;
		  padding: 10px;
		  font-size: 16px;
		}
		.form-signin .form-control:focus {
		  z-index: 2;
		}
		.form-signin input[type="email"] {
		  margin-bottom: -1px;
		  border-bottom-right-radius: 0;
		  border-bottom-left-radius: 0;
		}
		.form-signin input[type="password"] {
		  margin-bottom: 10px;
		  border-top-left-radius: 0;
		  border-top-right-radius: 0;
		}
		</style>
	</head>
	<body>
		<div class="container">
      <div class="row">
        <div class="col-md-2">
          <label for="response_type">response_type</label>
        </div>
        <div class="col-md-2">
          <select id="response_type" class="form-control">
            <option value="code">code</option>
            <option value="authorization_code">authorization_code</option>
            <option value="id_token">id_token</option>
            <option value="token">token</option>
            <option value="id_token token">id_token token</option>
            <option value="code id_token">code id_token</option>
            <option value="code token">code token</option>
            <option value="code id_token token">code id_token token</option>
            <option value="none">none</option>
            <option value="password">password</option>
            <option value="client_credentials">client_credentials</option>
            <option value="refresh_token">refresh_token</option>
            <option value="delete_token">delete_token</option>
            <option value="test_token">test_token</option>
            <option value="none">none</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="client_id">client</label>
        </div>
        <div class="col-md-2">
          <select id="client_id" class="form-control">
            <option value="client1_id">client1_id</option>
            <option value="client2_id">client2_id</option>
            <option value="client3_id">client3_id</option>
            <option value="client4_id">client4_id</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="clientpassword">client password</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="clientpassword" name="clientpassword" value="" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="clientpassword">client confidential</label>
        </div>
        <div class="col-md-2">
          <input type="checkbox" id="clientconfidential" name="clientconfidential" value="confidential" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="redirect_uri">redirect_uri</label>
        </div>
        <div class="col-md-2">
          <select id="redirect_uri" class="form-control">
            <option value="../../test-oidc.html?param=client1_cb1">uri_client1_1</option>
            <option value="../../test-oidc.html?param=client3">uri_client1_3</option>
            <option value="../../test-oidc.html?param=client4_cb">uri_client4</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="scope">scope</label>
        </div>
        <div class="col-md-2">
          <select id="scope" class="form-control" multiple size="3">
            <option value="openid" selected>openid</option>
            <option value="g_profile">g_profile</option>
            <option value="scope1">scope1</option>
            <option value="scope2">scope2</option>
            <option value="scope3">scope3</option>
            <option value="scope4">scope4</option>
            <option value="g_admin">g_admin</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="display">display</label>
        </div>
        <div class="col-md-2">
          <select id="display" class="form-control">
            <option value=""></option>
            <option value="page">page</option>
            <option value="popup">popup</option>
            <option value="touch">touch</option>
            <option value="wap">wap</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="prompt">prompt</label>
        </div>
        <div class="col-md-2">
          <select id="prompt" class="form-control">
            <option value=""></option>
            <option value="none">none</option>
            <option value="login">login</option>
            <option value="consent">consent</option>
            <option value="select_account">select_account</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="state">state</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="state" name="state" value="xyz" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="nonce">nonce</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="nonce" name="nonce" value="abc1234" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="max_age">max_age</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="max_age" name="max_age" value="" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="ui_locales">ui_locales</label>
        </div>
        <div class="col-md-2">
          <select id="ui_locales" class="form-control">
            <option value=""></option>
            <option value="en">en</option>
            <option value="fr">fr</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="login_hint">login_hint</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="login_hint" name="login_hint" value="" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="username">username</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="username" name="username" value="" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="password">password</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="password" name="password" value="" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="code">code</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="code" name="code" value="" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="refresh_token">refresh_token</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="refresh_token" name="refresh_token" value="" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="access_token">access_token</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="access_token" name="access_token" value="" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="access_token">id_token</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="id_token" name="id_token" value="" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-2">
          <label for="url">url to test access_token</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="url" name="url" value="api/oidc/userinfo" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <button type="button" name="run" id="run" class="btn btn-lg btn-primary btn-block">Run test</button>
        </div>
      </div>
      <div class="row">
        <div class="col-md-8" id="result" name="result" style="word-wrap: break-word;">
        </div>
      </div>
		</div>
	</body>
<script>
  var glewlwyd_api = "api/oidc";
  
  var params;
	function getQueryParams(qs) {
		qs = qs.split('+').join(' ');

		var params = {},
			tokens,
			re = /[?&]?([^=]+)=([^&]*)/g;

		while (tokens = re.exec(qs)) {
			params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
		}

		return params;
	}
	
	window.onload = function () {
		params = getQueryParams(location.search);
		if (params.code) {
		  $("#code").val(params.code);
		}
    if (params.access_token) {
      $("#access_token").val(params.access_token);
      $("#result").append("<div><strong>access_token</strong>: <code>" + params.access_token + "</code></div>");
    }
    
		params = getQueryParams(location.hash.substring(1));
		if (params.code) {
		  $("#code").val(params.code);
		}
    if (params.access_token) {
      $("#access_token").val(params.access_token);
      $("#result").append("<div><strong>access_token</strong>: <code>" + params.access_token + "</code></div>");
    }
    if (params.refresh_token) {
      $("#refresh_token").val(params.refresh_token);
      $("#result").append("<div><strong>refresh_token</strong>: <code>" + params.refresh_token + "</code></div>");
    }
    if (params.id_token) {
      $("#id_token").val(params.id_token);
      $("#result").append("<div><strong>id_token</strong>: <code>" + params.id_token + "</code></div>");
    }
	};

  function setAuthHeader(xhr){
    var creds = $("#client_id").val() + ':' + $("#clientpassword").val();
    var basicScheme = btoa(creds);
    var hashStr = "Basic "+basicScheme;
    xhr.setRequestHeader('Authorization', hashStr);
  }

  $("#run").click(function () {
    $("#result").empty();
    switch ($("#response_type").val()) {
      case "code":
      case "token":
      case "id_token":
      case "id_token token":
      case "code id_token":
      case "code token":
      case "code id_token token":
      case "none":
        var promptParam = "";
        if ($("#prompt").val() == "none" && $("#id_token").val()) {
          promptParam = "&prompt=" + $("#prompt").val() + "&id_token_hint=" + $("#id_token").val();
        } else {
          promptParam = "&prompt=" + $("#prompt").val();
        }
        var url = glewlwyd_api + "/auth?response_type=" + $("#response_type").val() + "&client_id=" + $("#client_id").val() + "&redirect_uri=" + $("#redirect_uri").val() + "&state=" + $("#state").val() + "&nonce=" + $("#nonce").val() + promptParam + "&display=" + $("#display").val() + "&scope=" + $("#scope").val().join(" ") + "&max_age=" + $("#max_age").val() + "&ui_locales=" + $("#ui_locales").val() + "&login_hint=" + $("#login_hint").val();
        window.location = url;
        break;
      case "authorization_code":
        $.ajax({
          type: "POST",
          url: glewlwyd_api + "/token", 
          data: {grant_type: "authorization_code", client_id: $("#client_id").val(), redirect_uri: $("#redirect_uri").val(), code: $("#code").val()},
          beforeSend: function (xhr) {
            if ($("#clientconfidential").is(':checked')) {
              xhr.setRequestHeader ("Authorization", "Basic " + btoa($("#client_id").val() + ":" + $("#clientpassword").val()));
            }
          },
          success: function (result, status, request) {
            $("#refresh_token").val(result.refresh_token);
            $("#access_token").val(result.access_token);
            $("#result").append("<div class=\"alert alert-info\">Success: " + request.getResponseHeader("content-type") + "</div>");
            for (var key in result) {
              $("#result").append("<div><strong>" + key + "</strong>: <code>" + result[key] + "</code></div>");
            }
          },
          error: function (error) {
              $("#result").append("<div class=\"alert alert-danger\">Error</div>");
              $("#result").append("<p>" + JSON.stringify(error, null, 4) + "</p>");
            }
        });
        break;
      case "password":
        $.ajax({
          type: "POST",
          url: glewlwyd_api + "/token", 
          data: {grant_type: "password", username: $("#username").val(), password: $("#password").val(), state: $("#state").val(), scope: $("#scope").val().join(" ")},
          beforeSend: function (xhr) {
            if ($("#clientconfidential").is(':checked')) {
              xhr.setRequestHeader ("Authorization", "Basic " + btoa($("#client_id").val() + ":" + $("#clientpassword").val()));
            }
          },
          success: function (result, status, request) {
            $("#result").append("<div class=\"alert alert-info\">Success: " + request.getResponseHeader("content-type") + "</div>");
            for (var key in result) {
              $("#result").append("<div><strong>" + key + "</strong>: <code>" + result[key] + "</code></div>");
            }
          },
          error: function (error) {
            $("#result").append("<div class=\"alert alert-danger\">Error</div>");
            $("#result").append("<p>" + JSON.stringify(error, null, 4) + "</p>");
          }
        });
        break;
      case "client_credentials":
        $.ajax
        ({
          type: "POST",
          url: glewlwyd_api + "/token",
          async: false,
          headers: {
            "Authorization": "Basic " + btoa($("#client_id").val() + ":" + $("#clientpassword").val())
          },
          data: {grant_type: "client_credentials", scope: $("#scope").val().join(" ")},
          success: function (result, status, request) {
            $("#result").append("<div class=\"alert alert-info\">Success: " + request.getResponseHeader("content-type") + "</div>");
            for (var key in result) {
              $("#result").append("<div><strong>" + key + "</strong>: <code>" + result[key] + "</code></div>");
            }
          },
          error: function (error) {
            $("#result").append("<div class=\"alert alert-danger\">Error</div>");
            $("#result").append("<p>" + JSON.stringify(error, null, 4) + "</p>");
          }
        });
        break;
      case "refresh_token":
        $.ajax({
          type: "POST",
          url: glewlwyd_api + "/token", 
          data: {grant_type: "refresh_token", refresh_token: $("#refresh_token").val()},
          beforeSend: function (xhr) {
            if ($("#clientconfidential").is(':checked')) {
              xhr.setRequestHeader ("Authorization", "Basic " + btoa($("#client_id").val() + ":" + $("#clientpassword").val()));
            }
          },
          success: function (result, status, request) {
            $("#result").append("<div class=\"alert alert-info\">Success: " + request.getResponseHeader("content-type") + "</div>");
            for (var key in result) {
              $("#result").append("<div><strong>" + key + "</strong>: <code>" + result[key] + "</code></div>");
            }
          },
          error:function (error) {
            $("#result").append("<div class=\"alert alert-danger\">Error</div>");
            $("#result").append("<p>" + JSON.stringify(error, null, 4) + "</p>");
          }
        });
        break;
      case "delete_token":
        $.ajax({
          type: "POST",
          url: glewlwyd_api + "/token", 
          data: {grant_type: "delete_token", refresh_token: $("#refresh_token").val()},
          beforeSend: function (xhr) {
            if ($("#clientconfidential").is(':checked')) {
              xhr.setRequestHeader ("Authorization", "Basic " + btoa($("#client_id").val() + ":" + $("#clientpassword").val()));
            }
          },
          success: function (result, status, request) {
            $("#result").append("<div class=\"alert alert-info\">Success</div>");
          },
          error:function (error) {
            $("#result").append("<div class=\"alert alert-danger\">Error</div>");
            $("#result").append("<p>" + JSON.stringify(error, null, 4) + "</p>");
          }
        });
        break;
      case "test_token":
        $.ajax({
          type: "GET",
          url: $("#url").val(),
          headers: {"Authorization": "Bearer " + $("#access_token").val()},
          success: function (result, status, request) {
            $("#result").append("<div class=\"alert alert-info\">"+JSON.stringify(result, null, 4)+"</div>");
          },
          error:function (error) {
            $("#result").append("<div class=\"alert alert-danger\">Error</div>");
            $("#result").append("<p>" + JSON.stringify(error, null, 4) + "</p>");
          }
        });
        break;
    }
  });
</script>
</html>
